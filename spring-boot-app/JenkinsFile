pipeline{
  agent any

  tools{
    maven 'maven'
  }

  stages{
    stage("Git Checkout"){
      steps{
        git branch: 'main', url: 'https://github.com/pranav0015/jenkins-pipeline-spring-boot'
      }
    }

    stage("Build and Test"){
      steps{
        sh 'cd /jenkins-pipeline-spring-boot/spring-boot-app/JenkinsFile' && mvn clean package
      }
    }

    stage("Static Code Analysis"){
      steps{
        withSonarQubeEnv('sonarqube-server') {
          sh 'mvn clean verify sonar:sonar'
        }
      }
    }
    
    stage("Build and Push Docker Image to DockerHub"){
      steps{
        scrips{
          withCredentials([usernameColonPassword(credentialsId: 'dockerhub_cred', variable: 'dockerhub_auth')]) {
          sh '''
            docker image build -t $JOB_NAME:v1.$BUILD_ID .
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:latest

            docker login -u pranav20003 -p ${dockerhub_auth}
            docker image push pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image push pranav20003/$JOB_NAME:latest
          '''
          }
        }
      }
    }

    stage("Update Deployment File"){
      environment{
        GIT_REPO_NAME = "jenkins-pipeline-spring-boot"
        GIT_USER_NAME = "pranav0015"
      }
      steps{
        git config user.email "pranavwakte580@gmail.com"
        git config user.name "pranav0015"

        BUILD_NUMBER = ${BUILD_NUMBER}
        sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" jenkins-pipeline-spring-boot/spring-boot-app-manifests/deployment.yml

        git add jenkins-pipeline-spring-boot/spring-boot-app-manifests/deployment.yml
        git commit -m "Update the deployment image to version ${BUILD_NUMBER}"
        git push https://${github_token}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main


      }
    }
  }
}