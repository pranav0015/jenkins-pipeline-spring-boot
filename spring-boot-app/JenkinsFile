pipeline{
  agent any

  tools{
    maven 'maven'
  }

  stages{
    stage("Git Checkout"){
      steps{
        git branch: 'main', url: 'https://github.com/pranav0015/jenkins-pipeline-spring-boot'
      }
    }

    stage("Build and Test"){
      steps{
        // spring-boot-pipeline is the pipeline jenkins job name here
        // Jenkins already clones the repo into workspace/spring-boot-pipeline
        sh 'cd spring-boot-app && mvn clean package' 
      }
    }

    stage("Static Code Analysis"){
      steps{
        withSonarQubeEnv('sonarqube-server') {
          sh 'cd spring-boot-app && mvn clean verify sonar:sonar'
        }
      }
    }
   stage("Build and Push Docker Image to DockerHub"){
      steps{
        script{
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub_cred', 
            passwordVariable: 'PASSWORD',  
            usernameVariable: 'USERNAME'
              )
            ]) {
          sh '''
            docker image build -t $JOB_NAME:v1.$BUILD_ID spring-boot-app
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:latest

            echo ${PASSWORD} | docker login -u ${USERNAME} --password-stdin
            docker image push pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image push pranav20003/$JOB_NAME:latest
          '''
          }
        }
      }
    }
  stage("Update Deployment File"){
      environment{
        GIT_REPO_NAME = "jenkins-pipeline-spring-boot"
        GIT_USER_NAME = "pranav0015"
      }
      steps{
          script{
          sh '''
            git config user.email "pranavwakte580@gmail.com"
            git config user.name "pranav0015"
            BUILD_NUMBER=${BUILD_NUMBER}
            sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" spring-boot-app-manifests/deployment.yml
            git add spring-boot-app-manifests/deployment.yml
            git commit -m "Update the deployment image to version ${BUILD_NUMBER}"
            git push https://${github_token}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main
           '''
        }
      }
    }
  }
}
