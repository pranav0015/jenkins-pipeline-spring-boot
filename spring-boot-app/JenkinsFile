pipeline{
  agent any

  tools{
    maven 'maven'
  }

  stages{
    stage("Git Checkout"){
      steps{
        git branch: 'main', url: 'https://github.com/pranav0015/jenkins-pipeline-spring-boot'
      }
    }

    stage("Build and Test"){
      steps{
        // spring-boot-pipeline is the pipeline jenkins job name here
        // Jenkins already clones the repo into workspace/spring-boot-pipeline
        sh 'cd spring-boot-app && mvn clean package' 
      }
    }

    stage("Static Code Analysis"){
      steps{
        withSonarQubeEnv('sonarqube-server') {
          sh 'cd spring-boot-app && mvn clean verify sonar:sonar'
        }
      }
    }
   stage("Build and Push Docker Image to DockerHub"){
      steps{
        script{
          withCredentials([string(credentialsId: 'dockerhub_cred', variable: 'dockerhub_auth')]) {
          sh '''
            docker image build -t $JOB_NAME:v1.$BUILD_ID spring-boot-app
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image tag $JOB_NAME:v1.$BUILD_ID pranav20003/$JOB_NAME:latest

            echo ${dockerhub_auth} | docker login -u pranav20003 --password-stdin
            docker image push pranav20003/$JOB_NAME:v1.$BUILD_ID
            docker image push pranav20003/$JOB_NAME:latest
          '''
          }
        }
      }
    }
  }
}
